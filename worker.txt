/**
 * OSXG+ Discord Stats — Cloudflare Worker
 *
 * Deploy this worker at: https://workers.cloudflare.com/
 *
 * Required environment variables (set in Cloudflare dashboard → Worker → Settings → Variables):
 *   DISCORD_BOT_TOKEN  — your Discord bot token (keep secret, use "Secret" type)
 *
 * This worker exposes a single endpoint:
 *   GET /stats  →  { members, online, tutorialCount }
 */

const GUILD_ID = "1474754589491335412";
const TUTORIALS_CHANNEL_ID = "1475091515142574143"; // #tutorials forum channel

// Your landing page origin — update if you host on a custom domain
const ALLOWED_ORIGIN = "*"; // or set to "https://yourdomain.com" for tighter security

export default {
  async fetch(request, env) {
    // Handle CORS preflight
    if (request.method === "OPTIONS") {
      return new Response(null, {
        headers: corsHeaders(),
      });
    }

    const url = new URL(request.url);

    if (url.pathname !== "/stats") {
      return new Response("Not found", { status: 404 });
    }

    try {
      const token = env.DISCORD_BOT_TOKEN;
      if (!token) {
        return jsonResponse({ error: "Bot token not configured" }, 500);
      }

      const headers = {
        Authorization: `Bot ${token}`,
        "Content-Type": "application/json",
      };

      // ── 1. Member & online count ──────────────────────────────────────────
      const guildRes = await fetch(
        `https://discord.com/api/v10/guilds/${GUILD_ID}?with_counts=true`,
        { headers }
      );
      const guild = await guildRes.json();

      const members = guild.approximate_member_count ?? 0;
      const online = guild.approximate_presence_count ?? 0;

      // ── 2. Tutorial forum post (thread) count ─────────────────────────────
      // Fetch active threads in the forum channel
      const activeRes = await fetch(
        `https://discord.com/api/v10/guilds/${GUILD_ID}/threads/active`,
        { headers }
      );
      const activeData = await activeRes.json();
      const activeThreads = (activeData.threads ?? []).filter(
        (t) => t.parent_id === TUTORIALS_CHANNEL_ID
      );

      // Fetch archived public threads (paginated — get up to 3 pages)
      let archivedCount = 0;
      let before = undefined;
      for (let page = 0; page < 3; page++) {
        const archUrl = `https://discord.com/api/v10/channels/${TUTORIALS_CHANNEL_ID}/threads/archived/public?limit=100${before ? `&before=${before}` : ""}`;
        const archRes = await fetch(archUrl, { headers });
        const archData = await archRes.json();
        const threads = archData.threads ?? [];
        archivedCount += threads.length;
        if (!archData.has_more || threads.length === 0) break;
        before = threads[threads.length - 1].thread_metadata?.archive_timestamp;
      }

      const tutorialCount = activeThreads.length + archivedCount;

      return jsonResponse({ members, online, tutorialCount });
    } catch (err) {
      return jsonResponse({ error: err.message }, 500);
    }
  },
};

function corsHeaders() {
  return {
    "Access-Control-Allow-Origin": ALLOWED_ORIGIN,
    "Access-Control-Allow-Methods": "GET, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type",
    "Cache-Control": "s-maxage=120", // Cache for 2 minutes
  };
}

function jsonResponse(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: {
      "Content-Type": "application/json",
      ...corsHeaders(),
    },
  });
}
